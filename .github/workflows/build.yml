name: Build HexMaster EXE with External Data Support

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # DÃ©clenchement manuel

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Prepare build directories
      run: |
        # S'assurer que les dossiers requis existent
        if (-not (Test-Path "custom_levels")) { 
          New-Item -ItemType Directory -Path "custom_levels" -Force
        }
        if (-not (Test-Path "custom_levels/.keep")) { 
          "# Dossier pour les niveaux crÃ©Ã©s par l'utilisateur" | Out-File -FilePath "custom_levels/.keep" -Encoding UTF8 
        }
    
    - name: Build executable with PyInstaller
      run: |
        pyinstaller --clean --noconfirm main.spec
        
    - name: Verify executable was created
      run: |
        if (Test-Path "dist/HexMaster/HexMaster.exe") {
          Write-Host "âœ… EXE crÃ©Ã© avec succÃ¨s (mode onedir)"
          Get-ChildItem "dist/HexMaster" -Recurse | Format-Table Name, Length, LastWriteTime
        } else {
          Write-Host "âŒ Erreur: EXE non trouvÃ©"
          Get-ChildItem dist/ -Recurse
          exit 1
        }
    
    - name: Create portable package with external data support
      run: |
        # CrÃ©er la structure portable
        $packageDir = "HexMaster_Portable"
        Remove-Item $packageDir -Recurse -Force -ErrorAction SilentlyContinue
        New-Item -ItemType Directory -Path $packageDir -Force
        
        # Copier tout le dossier de distribution (mode onedir)
        Copy-Item "dist/HexMaster/*" "$packageDir/" -Recurse -Force
        
        # CrÃ©er la structure de donnÃ©es externe
        New-Item -ItemType Directory -Path "$packageDir/HexMaster_Data" -Force
        New-Item -ItemType Directory -Path "$packageDir/HexMaster_Data/Campagne" -Force
        New-Item -ItemType Directory -Path "$packageDir/HexMaster_Data/custom_levels" -Force
        
        # Copier les niveaux de campagne (externes, modifiables)
        Copy-Item "Campagne/*" "$packageDir/HexMaster_Data/Campagne/" -Recurse -Force
        
        # CrÃ©er un fichier d'information
        @"
        # HexMaster - Edition Portable
        
        ## ğŸš€ DÃ©marrage rapide
        Double-cliquez sur HexMaster.exe pour jouer !
        
        ## ğŸ“ Structure des fichiers
        - **HexMaster.exe** : Jeu principal
        - **HexMaster_Data/** : Toutes vos donnÃ©es de jeu
          - **Campagne/** : Niveaux de campagne (vous pouvez les modifier !)
          - **custom_levels/** : Vos niveaux crÃ©Ã©s avec l'Ã©diteur
          - **sauvegarde.json** : Votre progression (crÃ©Ã© automatiquement)
        
        ## ğŸ® FonctionnalitÃ©s
        - âœ… Campagne complÃ¨te avec progression
        - âœ… Mode HexArÃ¨ne (combat contre IA)
        - âœ… Mode Joueur vs Joueur local
        - âœ… **Ã‰diteur de niveaux intÃ©grÃ©** 
        - âœ… **Niveaux crÃ©Ã©s sauvegardÃ©s de faÃ§on permanente**
        - âœ… SystÃ¨me de points et dÃ©blocage d'unitÃ©s
        
        ## ğŸ”§ CrÃ©er vos propres niveaux
        1. Lancez le jeu
        2. Menu Principal â†’ Ã‰diteur de Niveaux
        3. CrÃ©ez votre niveau
        4. Sauvegardez-le
        5. Il apparaÃ®tra dans la liste des niveaux disponibles !
        
        **Les niveaux crÃ©Ã©s sont sauvegardÃ©s dans :** HexMaster_Data/custom_levels/
        
        ## ğŸ’¾ Sauvegarde de progression
        Votre progression est automatiquement sauvegardÃ©e dans :
        **HexMaster_Data/sauvegarde.json**
        
        Sauvegardez ce fichier pour conserver votre progression !
        
        ## ğŸ› ï¸ DÃ©pannage
        - Si le jeu ne se lance pas : vÃ©rifiez que tous les fichiers sont prÃ©sents
        - Si vos niveaux disparaissent : ils sont dans HexMaster_Data/custom_levels/
        - Si la progression est perdue : restaurez sauvegarde.json
        
        ## Version
        Build: ${{ github.sha }}
        Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm')
        "@ | Out-File -FilePath "$packageDir/README.txt" -Encoding UTF8
        
        # Script de lancement (optionnel)
        @"
        @echo off
        title HexMaster Launcher
        echo =====================================
        echo       HexMaster - Lanceur
        echo =====================================
        echo.
        echo Verification des dossiers...
        if not exist "HexMaster_Data" (
            echo Creation du dossier de donnees...
            mkdir "HexMaster_Data"
            mkdir "HexMaster_Data\custom_levels"
        )
        echo.
        echo Lancement de HexMaster...
        start "" "HexMaster.exe"
        echo.
        echo HexMaster lance avec succes !
        echo Vous pouvez fermer cette fenetre.
        pause
        "@ | Out-File -FilePath "$packageDir/Lancer_HexMaster.bat" -Encoding ASCII
        
        Write-Host "âœ… Package portable crÃ©Ã© avec support des donnÃ©es externes"
        Get-ChildItem $packageDir -Recurse | Select-Object Name, Length | Format-Table
    
    - name: Create ZIP archive
      run: |
        $archiveName = "HexMaster_Portable_Windows.zip"
        Compress-Archive -Path "HexMaster_Portable/*" -DestinationPath $archiveName -Force
        Write-Host "âœ… Archive crÃ©Ã©e: $archiveName"
        $archive = Get-ChildItem $archiveName
        Write-Host "Taille: $([math]::Round($archive.Length / 1MB, 2)) MB"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: HexMaster-Windows-Portable
        path: |
          HexMaster_Portable_Windows.zip
          HexMaster_Portable/
        retention-days: 30
    
    # GÃ©nÃ©rer une version avec timestamp pour les builds automatiques
    - name: Generate version tag
      id: version
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          $version = "${{ github.ref_name }}"
        } else {
          $timestamp = Get-Date -Format "yyyy.MM.dd.HHmm"
          $version = "auto-v$timestamp"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Generated version: $version"
    
    # CrÃ©er une release seulement pour les tags ou les builds manuels
    - name: Create Release
      if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: HexMaster ${{ steps.version.outputs.VERSION }}
        files: HexMaster_Portable_Windows.zip
        draft: false
        prerelease: ${{ !startsWith(github.ref, 'refs/tags/v') }}
        body: |
          ## ğŸ® HexMaster ${{ steps.version.outputs.VERSION }}
          
          ### ğŸ†• Nouvelles fonctionnalitÃ©s de cette version
          - **ğŸ”¥ Ã‰diteur de niveaux fonctionnel en version EXE !**
          - **ğŸ’¾ Niveaux crÃ©Ã©s sauvegardÃ©s de faÃ§on permanente**
          - **ğŸ“ SystÃ¨me de donnÃ©es externes** : plus de problÃ¨mes de niveaux perdus
          - **ğŸ› ï¸ Structure portable complÃ¨te** avec tous les fichiers nÃ©cessaires
          
          ### ğŸ“¦ Contenu du package
          - `HexMaster.exe` : Jeu principal
          - `HexMaster_Data/` : **Dossier de donnÃ©es externe**
            - `Campagne/` : Niveaux de campagne (modifiables)
            - `custom_levels/` : **Vos crÃ©ations sont sauvegardÃ©es ici !**
            - `sauvegarde.json` : Votre progression (crÃ©Ã© automatiquement)
          - `README.txt` : Guide complet d'utilisation
          - `Lancer_HexMaster.bat` : Script de lancement optionnel
          
          ### ğŸš€ Installation
          1. **TÃ©lÃ©charger** : `HexMaster_Portable_Windows.zip`
          2. **Extraire** dans un dossier de votre choix
          3. **Lancer** : Double-clic sur `HexMaster.exe`
          4. **Jouer** ! ğŸ¯
          
          ### ğŸ¯ FonctionnalitÃ©s
          - âœ… **Campagne complÃ¨te** avec systÃ¨me de progression
          - âœ… **Mode HexArÃ¨ne** : combats gÃ©nÃ©rÃ©s contre l'IA
          - âœ… **Mode JcJ local** : affrontez un ami sur le mÃªme PC
          - âœ… **Ã‰diteur de niveaux intÃ©grÃ©** : crÃ©ez vos propres dÃ©fis
          - âœ… **Persistance garantie** : vos crÃ©ations ne disparaissent plus !
          - âœ… **Modification des niveaux de campagne** possible
          
          ### ğŸ”§ Utilisation de l'Ã©diteur
          1. Menu Principal â†’ **Ã‰diteur de Niveaux**
          2. CrÃ©ez votre niveau (unitÃ©s, objectifs, rÃ©compenses)
          3. **Sauvegardez** avec un nom unique
          4. Votre niveau apparaÃ®t dans **"Niveaux Custom"**
          5. **Testez-le** : sÃ©lectionnez et jouez !
          
          **ğŸ‰ Vos niveaux restent disponibles aprÃ¨s redÃ©marrage du jeu !**
          
          ### ğŸ“Š Informations techniques
          - Build: `${{ github.sha }}`
          - Python: 3.11
          - PyInstaller: Version rÃ©cente
          - Compatible: Windows 10/11
          - Taille: ~XX MB
          
          ---
          
          **ğŸ› ProblÃ¨mes ?** â†’ [Issues GitHub](https://github.com/${{ github.repository }}/issues)
          **ğŸ’¬ Discussions ?** â†’ [Discord/Forum](lien_si_disponible)
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
